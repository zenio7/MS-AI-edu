<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°œë… ë¹„êµ ëª¨ë“œ - Interactive Concept Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f, #4d79ff);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .comparison-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .concept-input {
            position: relative;
        }

        .concept-input input {
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            width: 200px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
            transition: all 0.3s ease;
        }

        .concept-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .concept-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .vs-text {
            font-size: 1.5rem;
            font-weight: bold;
            align-self: center;
            color: #ffd93d;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .visualization-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #cy {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd93d;
            margin-bottom: 5px;
        }

        .export-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: white;
        }

        .export-btn.mermaid {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }

        .export-btn.png {
            background: linear-gradient(135deg, #4d79ff, #7ba7ff);
        }

        .export-btn.json {
            background: linear-gradient(135deg, #6bcf7f, #95d5a3);
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .toggle-btn:first-child {
            border-radius: 20px 0 0 20px;
        }

        .toggle-btn:last-child {
            border-radius: 0 20px 20px 0;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #ffd93d, #ffeb3b);
            color: #333;
            font-weight: bold;
        }

        .mode-description {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .controls-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #6bcf7f, #95d5a3);
            color: #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-config input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .api-config input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .concept-count-selector select {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #333 !important;
            border: 2px solid rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        .concept-count-selector select:focus {
            outline: none;
            background: rgba(255, 255, 255, 1) !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .concept-count-selector select option {
            background: white !important;
            color: #333 !important;
            padding: 5px;
        }

        /* Zoom slider styles */
        .zoom-control {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 15px 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .zoom-slider-container {
            position: relative;
            width: 30px;
            height: 150px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 150px;
            height: 8px;
            background: linear-gradient(to right, #ff6b6b 0%, #ffd93d 50%, #6bcf7f 100%);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            transform: rotate(-90deg) translate(-40%, -5%);;
            transform-origin: center;
            position: absolute;
            top: 11px;
            left: -60px;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: 2px solid #ffd93d;
            transition: all 0.2s ease;
        }

        .zoom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
        }

        .zoom-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: 2px solid #ffd93d;
            transition: all 0.2s ease;
        }

        .zoom-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
        }

        .zoom-slider::-moz-range-track {
            background: transparent;
        }

        .zoom-label {
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .zoom-value {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 10px;
            min-width: 40px;
            text-align: center;
        }

        .zoom-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Interactive Concept Explorer</h1>
            <p class="subtitle">AI-Powered Knowledge Network Visualization</p>
        </div>

        <div id="mode-description" class="mode-description">
            <strong>í‚¤ì›Œë“œ ë§ˆì¸ë“œë§µ:</strong> <span id="description-text">1-5ê°œ ê°œë…ì„ AIê°€ ë¶„ì„í•˜ì—¬ ê´€ê³„ì™€ íŠ¹ì„±ì„ ì‹œê°í™”í•©ë‹ˆë‹¤.</span>
        </div>

        <div class="comparison-controls">
            <div class="concept-count-selector" style="text-align: center; align-items: center;">
                <label style="margin-right: 10px; font-weight: bold;">ë¶„ì„í•  ê°œë… ìˆ˜:</label>
                <select id="conceptCount" onchange="updateConceptInputs()" style="padding: 8px; border-radius: 10px; margin-right: 10px;">
                    <option value="1">1ê°œ (ë‹¨ë… ë¶„ì„)</option>
                    <option value="2" selected>2ê°œ (ë¹„êµ ë¶„ì„)</option>
                    <option value="3">3ê°œ (ë‹¤ì¤‘ ë¹„êµ)</option>
                    <option value="4">4ê°œ (ë‹¤ì¤‘ ë¹„êµ)</option>
                    <option value="5">5ê°œ (ë‹¤ì¤‘ ë¹„êµ)</option>
                </select>
            </div>

            <div id="conceptInputs" class="concept-inputs-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center;">
                <!-- Dynamic inputs will be generated here -->
            </div>
        </div>

        <!-- Generate Button -->
        <div class="api-config" style="text-align: center; margin-bottom: 20px;">
            <button onclick="generateConceptsWithAI()" id="generateBtn" class="control-btn" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; padding: 12px 30px; font-size: 16px;">ğŸ¤– AIë¡œ ê°œë… ë¶„ì„í•˜ê¸°</button>
        </div>

        <!-- Loading and Status -->
        <div id="loadingStatus" class="mode-description" style="display: none;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #ffd93d; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>AIê°€ ê°œë…ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
            </div>
        </div>

        <div class="controls-panel">
            <button class="control-btn active" onclick="changeLayout('cose')" id="layout-cose">Force Layout</button>
            <button class="control-btn" onclick="changeLayout('circle')" id="layout-circle">Circle Layout</button>
            <button class="control-btn" onclick="changeLayout('concentric')" id="layout-concentric">Concentric Layout</button>
            <button class="control-btn" onclick="changeLayout('breadthfirst')" id="layout-breadth">Hierarchical</button>
        </div>

        <div class="visualization-area">
            <div id="cy" style="position: relative;">
                <!-- Zoom Control -->
                <div class="zoom-control" id="zoomControl" style="display: none;">
                    <div class="zoom-label">ZOOM</div>
                    <div class="zoom-buttons">
                        <button class="zoom-btn" onclick="zoomIn()" title="í™•ëŒ€">+</button>
                        <button class="zoom-btn" onclick="zoomOut()" title="ì¶•ì†Œ">-</button>
                    </div>
                    <div class="zoom-slider-container">
                        <input type="range"
                               class="zoom-slider"
                               id="zoomSlider"
                               min="0.25"
                               max="3"
                               step="0.02"
                               value="1"
                               oninput="handleZoomSlider(this.value)"
                               onchange="handleZoomSlider(this.value)"
                               title="í™•ëŒ€/ì¶•ì†Œ">
                    </div>
                    <div class="zoom-value" id="zoomValue">100%</div>
                    <button class="zoom-btn" onclick="resetZoom()" title="ì´ˆê¸°í™”" style="margin-top: 10px; font-size: 12px;">ğŸ </button>
                </div>

                <div id="emptyState" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: rgba(255,255,255,0.7);">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ìš°ì„  ê°œë… ë¶„ì„ì„ í•´ì£¼ì„¸ìš”</div>
                    <div style="font-size: 14px;">ìœ„ì—ì„œ ê°œë…ë“¤ì„ ì…ë ¥í•˜ê³  'AIë¡œ ê°œë… ë¶„ì„í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);"></div>
                    <span>ì£¼ìš” ê°œë…ë“¤</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #6bcf7f, #95d5a3);"></div>
                    <span>ê³µí†µ ê°œë…</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ffd93d, #ffeb3b);"></div>
                    <span>ê³ ìœ  ê°œë…</span>
                </div>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="shared-count">-</div>
                <div>ê³µí†µ ê°œë…</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-unique-count">-</div>
                <div>ì´ ê³ ìœ  ê°œë…</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="concept-count">-</div>
                <div>ë¶„ì„ ê°œë… ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-similarity">-</div>
                <div>í‰ê·  ê´€ë ¨ì„±</div>
            </div>
        </div>

        <div class="export-panel">
            <h3 style="text-align: center; margin-bottom: 15px;">ğŸ“¤ Export Options</h3>
            <div class="export-buttons">
                <button class="export-btn mermaid" onclick="exportMermaid()">Mermaid ë‹¤ì´ì–´ê·¸ë¨</button>
                <button class="export-btn png" onclick="exportPNG()">PNG ì´ë¯¸ì§€</button>
                <button class="export-btn json" onclick="exportJSON()">JSON ë°ì´í„°</button>
            </div>
        </div>
    </div>

    <script>
        let cy;
        let currentLayout = 'cose';
        let isGenerating = false;

        // Backend API Configuration
        const BACKEND_API_URL = 'http://localhost:8000';

        // Data will be populated after AI analysis
        let conceptData = null;

        function initializeCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'color': 'white',
                            'text-outline-width': 2,
                            'text-outline-color': 'rgba(0,0,0,0.5)',
                            'width': '80px',
                            'height': '80px',
                            'border-width': 3,
                            'border-opacity': 0.8,
                            'transition-property': 'all',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'node[type="main1"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#ff6b6b #ff8e8e',
                            'border-color': '#ff4757',
                            'width': '100px',
                            'height': '100px',
                            'font-size': '14px'
                        }
                    },
                    {
                        selector: 'node[type="main2"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#4d79ff #7ba7ff',
                            'border-color': '#3742fa',
                            'width': '100px',
                            'height': '100px',
                            'font-size': '14px'
                        }
                    },
                    {
                        selector: 'node[type="shared"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#6bcf7f #95d5a3',
                            'border-color': '#2ed573',
                            'width': '85px',
                            'height': '85px'
                        }
                    },
                    {
                        selector: 'node[type="unique1"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#ffd93d #ffeb3b',
                            'border-color': '#ffa502',
                            'color': '#333',
                            'text-outline-color': 'rgba(255,255,255,0.8)',
                            'width': '70px',
                            'height': '70px'
                        }
                    },
                    {
                        selector: 'node[type="unique2"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#a8edea #fed6e3',
                            'border-color': '#ff9ff3',
                            'color': '#333',
                            'text-outline-color': 'rgba(255,255,255,0.8)',
                            'width': '70px',
                            'height': '70px'
                        }
                    },
                    {
                        selector: 'node:hover',
                        style: {
                            'overlay-color': 'rgba(255,255,255,0.2)',
                            'overlay-padding': '10px',
                            'z-index': 10
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': 'rgba(255,255,255,0.4)',
                            'target-arrow-color': 'rgba(255,255,255,0.4)',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'opacity': 0.7,
                            'animation-name': 'flow',
                            'animation-duration': '2s',
                            'animation-iteration-count': 'infinite'
                        }
                    },
                    {
                        selector: 'edge[type="strong"]',
                        style: {
                            'width': 5,
                            'line-color': '#ffd93d',
                            'target-arrow-color': '#ffd93d',
                            'opacity': 0.9
                        }
                    },
                    {
                        selector: 'edge[type="shared"]',
                        style: {
                            'width': 4,
                            'line-color': '#6bcf7f',
                            'target-arrow-color': '#6bcf7f',
                            'opacity': 0.8
                        }
                    }
                ],

                elements: [],

                layout: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    randomize: false,
                    componentSpacing: 100,
                    nodeOverlap: 20,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 2000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0
                }
            });

            // ë…¸ë“œ í´ë¦­ ì´ë²¤íŠ¸
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const concept = node.data('label');
                showConceptTooltip(concept, evt.renderedPosition);
                
                // ì—°ê²°ëœ ë…¸ë“œë“¤ ê°•ì¡°
                const connectedNodes = node.connectedEdges().connectedNodes();
                cy.elements().removeClass('highlighted');
                node.addClass('highlighted');
                connectedNodes.addClass('highlighted');
            });

            generateGraph();
        }

        // Dynamic input field management
        function updateConceptInputs() {
            const count = parseInt(document.getElementById('conceptCount').value);
            const container = document.getElementById('conceptInputs');

            // Update description based on concept count
            const descriptionText = document.getElementById('description-text');
            if (count === 1) {
                descriptionText.textContent = '1ê°œ ê°œë…ì„ AIê°€ ê¹Šì´ ë¶„ì„í•˜ì—¬ í•µì‹¬ íŠ¹ì„±ë“¤ì„ ì‹œê°í™”í•©ë‹ˆë‹¤.';
            } else {
                descriptionText.textContent = `${count}ê°œ ê°œë…ì„ AIê°€ ë¶„ì„í•˜ì—¬ ê³µí†µì ê³¼ ì°¨ì´ì ì„ ì‹œê°í™”í•©ë‹ˆë‹¤.`;
            }

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                // Add VS text between inputs (not before first, and only if more than 1 concept)
                if (i > 0 && count > 1) {
                    const vsDiv = document.createElement('div');
                    vsDiv.className = 'vs-text';
                    vsDiv.textContent = 'VS';
                    vsDiv.style.fontSize = '1.2rem';
                    vsDiv.style.fontWeight = 'bold';
                    vsDiv.style.color = '#ffd93d';
                    vsDiv.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';
                    container.appendChild(vsDiv);
                }

                const inputDiv = document.createElement('div');
                inputDiv.className = 'concept-input';

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `concept${i + 1}`;
                input.placeholder = count === 1 ? 'ë¶„ì„í•  ê°œë…' : `ê°œë… ${i + 1}`;
                input.addEventListener('input', debounce(() => {
                    // Could add real-time validation here
                }, 500));

                inputDiv.appendChild(input);
                container.appendChild(inputDiv);
            }
        }

        function generateGraph() {
            if (!conceptData) {
                console.log('No concept data available');
                return;
            }

            // Hide empty state, show stats and zoom control
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'grid';
            document.getElementById('zoomControl').style.display = 'flex';

            const elements = [];
            const colors = [
                '#ff6b6b', '#4d79ff', '#a8edea', '#ffa8e4', '#ff9f43'  // Colors for different concepts
            ];

            // Main concept nodes
            conceptData.concepts.forEach((concept, index) => {
                elements.push({
                    data: {
                        id: `main_${index}`,
                        label: concept.name,
                        type: `main${index + 1}`,
                        color: colors[index % colors.length]
                    }
                });
            });

            // Shared concepts (only if more than 1 concept and has shared concepts)
            if (conceptData.concepts.length > 1 && conceptData.shared_concepts.length > 0) {
                conceptData.shared_concepts.forEach((sharedConcept, i) => {
                    const id = `shared_${i}`;
                    elements.push({
                        data: {
                            id,
                            label: sharedConcept,
                            type: 'shared'
                        }
                    });

                    // Connect to all main concepts
                    conceptData.concepts.forEach((_, conceptIndex) => {
                        elements.push({
                            data: {
                                id: `edge_main${conceptIndex}_${id}`,
                                source: `main_${conceptIndex}`,
                                target: id,
                                type: 'shared'
                            }
                        });
                    });
                });
            }

            // Unique concepts for each main concept
            conceptData.concepts.forEach((concept, conceptIndex) => {
                concept.unique.forEach((uniqueConcept, i) => {
                    const id = `unique_${conceptIndex}_${i}`;
                    elements.push({
                        data: {
                            id,
                            label: uniqueConcept,
                            type: `unique${conceptIndex + 1}`
                        }
                    });

                    // Connect to main concept
                    elements.push({
                        data: {
                            id: `edge_main${conceptIndex}_${id}`,
                            source: `main_${conceptIndex}`,
                            target: id,
                            type: 'normal'
                        }
                    });
                });
            });
            
            cy.elements().remove();
            cy.add(elements);
            
            // ë ˆì´ì•„ì›ƒ ì ìš©
            const layout = cy.layout({
                name: currentLayout,
                animate: true,
                animationDuration: 1000,
                randomize: false,
                componentSpacing: 100,
                nodeOverlap: 20,
                nestingFactor: 5,
                gravity: 80,
                numIter: 2000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0,
                spacingFactor: 1.5
            });

            layout.run();

            // ë ˆì´ì•„ì›ƒ ì™„ë£Œ í›„ ì¤Œ ìƒíƒœ ì´ˆê¸°í™”
            layout.on('layoutstop', function() {
                setTimeout(() => {
                    const zoomLevel = cy.zoom();
                    updateZoomSlider(zoomLevel);
                    updateZoomValue(zoomLevel);
                }, 100);
            });

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStats();
        }

        function changeLayout(layoutName) {
            currentLayout = layoutName;
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`layout-${layoutName}`).classList.add('active');
            
            const layoutOptions = {
                cose: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    componentSpacing: 100,
                    nodeOverlap: 20,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 2000,
                    spacingFactor: 1.5
                },
                circle: {
                    name: 'circle',
                    animate: true,
                    animationDuration: 1000,
                    spacing: 100
                },
                concentric: {
                    name: 'concentric',
                    animate: true,
                    animationDuration: 1000,
                    spacingFactor: 2,
                    concentric: function(node) {
                        if (node.data('type').includes('main')) return 3;
                        if (node.data('type') === 'shared') return 2;
                        return 1;
                    },
                    levelWidth: function() { return 1; }
                },
                breadthfirst: {
                    name: 'breadthfirst',
                    animate: true,
                    animationDuration: 1000,
                    directed: true,
                    roots: ['main1', 'main2'],
                    spacingFactor: 1.5
                }
            };
            
            const layout = cy.layout(layoutOptions[layoutName]);
            layout.run();

            // ë ˆì´ì•„ì›ƒ ë³€ê²½ ì™„ë£Œ í›„ ì¤Œ ìƒíƒœ ì—…ë°ì´íŠ¸
            layout.on('layoutstop', function() {
                setTimeout(() => {
                    const zoomLevel = cy.zoom();
                    updateZoomSlider(zoomLevel);
                    updateZoomValue(zoomLevel);
                }, 100);
            });
        }


        function showConceptTooltip(concept, position) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì—¬ê¸°ì— ìƒì„¸ ì •ë³´ íŒì—… í‘œì‹œ
            console.log(`Concept clicked: ${concept} at position:`, position);
        }

        function updateStats() {
            if (!conceptData) return;

            const isSingleConcept = conceptData.concepts.length === 1;

            if (isSingleConcept) {
                // Single concept stats
                document.getElementById('shared-count').textContent = '-';
                document.getElementById('total-unique-count').textContent = conceptData.concepts[0].unique.length;
                document.getElementById('concept-count').textContent = '1 (ë‹¨ë… ë¶„ì„)';
                document.getElementById('avg-similarity').textContent = '-';

                // Update stat labels for single concept
                document.querySelector('#statsPanel .stat-card:nth-child(1) div:last-child').textContent = 'ê³µí†µ ê°œë… (í•´ë‹¹ ì—†ìŒ)';
                document.querySelector('#statsPanel .stat-card:nth-child(2) div:last-child').textContent = 'í•µì‹¬ íŠ¹ì„±';
                document.querySelector('#statsPanel .stat-card:nth-child(4) div:last-child').textContent = 'ê´€ë ¨ì„± (í•´ë‹¹ ì—†ìŒ)';
            } else {
                // Multi-concept stats
                document.getElementById('shared-count').textContent = conceptData.shared_concepts.length;
                const totalUniqueCount = conceptData.concepts.reduce((sum, concept) => sum + concept.unique.length, 0);
                document.getElementById('total-unique-count').textContent = totalUniqueCount;
                document.getElementById('concept-count').textContent = conceptData.concepts.length;

                // Calculate average similarity based on shared vs total concepts
                const totalConcepts = conceptData.shared_concepts.length + totalUniqueCount;
                const avgSimilarity = totalConcepts > 0 ? Math.round((conceptData.shared_concepts.length / totalConcepts) * 100) : 0;
                document.getElementById('avg-similarity').textContent = avgSimilarity + '%';

                // Reset stat labels for multi-concept
                document.querySelector('#statsPanel .stat-card:nth-child(1) div:last-child').textContent = 'ê³µí†µ ê°œë…';
                document.querySelector('#statsPanel .stat-card:nth-child(2) div:last-child').textContent = 'ì´ ê³ ìœ  ê°œë…';
                document.querySelector('#statsPanel .stat-card:nth-child(4) div:last-child').textContent = 'í‰ê·  ê´€ë ¨ì„±';
            }
        }

        function exportMermaid() {
            if (!conceptData) {
                alert('ë¨¼ì € ê°œë… ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            let code = "graph TD\n";

            // ìŠ¤íƒ€ì¼ ì •ì˜
            code += "    classDef shared fill:#6bcf7f,stroke:#2ed573,stroke-width:2px,color:#fff\n";
            code += "    classDef unique fill:#ffd93d,stroke:#ffa502,stroke-width:2px,color:#333\n";

            // ë©”ì¸ ë…¸ë“œë“¤ê³¼ ìŠ¤íƒ€ì¼
            conceptData.concepts.forEach((concept, i) => {
                const mainId = String.fromCharCode(65 + i); // A, B, C, D, E
                code += `    classDef main${i + 1} fill:#${['ff6b6b', '4d79ff', 'a8edea', 'ffa8e4', 'ff9f43'][i]},stroke-width:3px,color:#fff\n`;
                code += `    ${mainId}[${concept.name}]:::main${i + 1}\n`;
            });

            code += "\n";

            // ê³µí†µ ê°œë…ë“¤
            conceptData.shared_concepts.forEach((concept, i) => {
                const id = `S${i}`;
                code += `    ${id}[${concept}]:::shared\n`;
                conceptData.concepts.forEach((_, conceptIndex) => {
                    const mainId = String.fromCharCode(65 + conceptIndex);
                    code += `    ${mainId} --> ${id}\n`;
                });
            });

            code += "\n";

            // ê³ ìœ  ê°œë…ë“¤
            conceptData.concepts.forEach((concept, conceptIndex) => {
                const mainId = String.fromCharCode(65 + conceptIndex);
                concept.unique.slice(0, 6).forEach((uniqueConcept, i) => {
                    const id = `U${conceptIndex}${i}`;
                    code += `    ${id}[${uniqueConcept}]:::unique\n`;
                    code += `    ${mainId} --> ${id}\n`;
                });
            });

            navigator.clipboard.writeText(code).then(() => {
                alert('ğŸ‰ Mermaid ë‹¤ì´ì–´ê·¸ë¨ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nGitHub READMEì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.\n\n' + code.substring(0, 200) + '...');
            });
        }

        function exportPNG() {
            const png64 = cy.png({
                output: 'base64uri',
                bg: 'transparent',
                full: true,
                scale: 2
            });
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const link = document.createElement('a');
            link.download = 'concept-comparison.png';
            link.href = png64;
            link.click();
        }

        function exportJSON() {
            if (!conceptData) {
                alert('ë¨¼ì € ê°œë… ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const conceptCount = parseInt(document.getElementById('conceptCount').value);
            const concepts = [];
            for (let i = 1; i <= conceptCount; i++) {
                concepts.push(document.getElementById(`concept${i}`).value);
            }

            const jsonData = {
                analysis: {
                    input_concepts: concepts,
                    concept_count: conceptData.concepts.length,
                    concepts: conceptData.concepts,
                    shared_concepts: conceptData.shared_concepts,
                    total_unique_concepts: conceptData.concepts.reduce((sum, c) => sum + c.unique.length, 0),
                    avg_similarity: parseInt(document.getElementById('avg-similarity').textContent) / 100,
                    layout: currentLayout,
                    generated_at: new Date().toISOString(),
                    graph_data: cy ? cy.json() : null
                }
            };

            navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2)).then(() => {
                alert('ğŸ“Š JSON ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ë°±ì—”ë“œ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê°œë… ë°ì´í„° ìƒì„±
        async function generateConceptsWithAI() {
            const conceptCount = parseInt(document.getElementById('conceptCount').value);
            const concepts = [];

            // Collect all concept values
            for (let i = 1; i <= conceptCount; i++) {
                const concept = document.getElementById(`concept${i}`).value.trim();
                if (!concept) {
                    if (conceptCount === 1) {
                        alert('ë¶„ì„í•  ê°œë…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    } else {
                        alert(`ê°œë… ${i}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    }
                    return;
                }
                concepts.push(concept);
            }

            // Check for duplicates (only if more than 1 concept)
            if (conceptCount > 1) {
                const uniqueConcepts = [...new Set(concepts.map(c => c.toLowerCase()))];
                if (uniqueConcepts.length !== concepts.length) {
                    alert('ëª¨ë“  ê°œë…ì€ ì„œë¡œ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
            }

            if (isGenerating) {
                return;
            }

            isGenerating = true;
            showLoadingState(true);

            try {
                const response = await fetch(`${BACKEND_API_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        concepts: concepts
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();

                // ìƒì„±ëœ ë°ì´í„°ë¡œ conceptData ì—…ë°ì´íŠ¸
                conceptData = {
                    concepts: data.concepts,
                    shared_concepts: data.shared_concepts,
                    analysis_type: data.analysis_type
                };

                // ê·¸ë˜í”„ ë‹¤ì‹œ ìƒì„±
                generateGraph();

                let message;
                if (conceptCount === 1) {
                    message = `âœ¨ AIê°€ "${concepts[0]}"ì˜ ë¶„ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!\n`;
                    message += `í•µì‹¬ íŠ¹ì„±: ${data.concepts[0].unique.length}ê°œ`;
                } else {
                    message = `âœ¨ AIê°€ ${conceptCount}ê°œ ê°œë…ì˜ ë¹„êµ ë¶„ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!\n`;
                    message += `ê³µí†µ ê°œë…: ${data.shared_concepts.length}ê°œ\n`;
                    message += `ì´ ê³ ìœ  ê°œë…: ${data.concepts.reduce((sum, c) => sum + c.unique.length, 0)}ê°œ`;
                }

                if (data.analysis_id) {
                    message += `\n\nğŸ” ë¶„ì„ ID: ${data.analysis_id}`;
                    console.log(`LangSmith Trace ID: ${data.analysis_id}`);
                }

                alert(message);

            } catch (error) {
                console.error('AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);

                if (error.message.includes('Failed to fetch')) {
                    alert('âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”:\n1. cd backend\n2. python main.py');
                } else {
                    alert(`âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            } finally {
                isGenerating = false;
                showLoadingState(false);
            }
        }


        function showLoadingState(show) {
            const loadingDiv = document.getElementById('loadingStatus');
            const generateBtn = document.getElementById('generateBtn');

            if (show) {
                loadingDiv.style.display = 'block';
                generateBtn.disabled = true;
                generateBtn.textContent = 'ìƒì„± ì¤‘...';
                generateBtn.style.opacity = '0.6';
            } else {
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'AIë¡œ ê°œë… ìƒì„±';
                generateBtn.style.opacity = '1';
            }
        }

        // Zoom control functions
        function handleZoomSlider(value) {
            if (cy) {
                const zoomLevel = parseFloat(value);
                cy.zoom(zoomLevel);
                cy.center();
                updateZoomValue(zoomLevel);

                // ìŠ¬ë¼ì´ë” ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì €ì¥ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
                localStorage.setItem('conceptZoomLevel', zoomLevel.toString());
            }
        }

        function zoomIn() {
            if (cy) {
                const currentZoom = cy.zoom();
                const newZoom = Math.min(currentZoom * 1.2, 3);
                cy.zoom(newZoom);
                cy.center();
                updateZoomSlider(newZoom);
                updateZoomValue(newZoom);
            }
        }

        function zoomOut() {
            if (cy) {
                const currentZoom = cy.zoom();
                const newZoom = Math.max(currentZoom / 1.2, 0.25);
                cy.zoom(newZoom);
                cy.center();
                updateZoomSlider(newZoom);
                updateZoomValue(newZoom);
            }
        }

        function resetZoom() {
            if (cy) {
                cy.fit();
                const zoomLevel = cy.zoom();
                updateZoomSlider(zoomLevel);
                updateZoomValue(zoomLevel);
            }
        }

        function updateZoomSlider(zoomLevel) {
            const slider = document.getElementById('zoomSlider');
            if (slider) {
                slider.value = zoomLevel;
            }
        }

        function updateZoomValue(zoomLevel) {
            const zoomValue = document.getElementById('zoomValue');
            if (zoomValue) {
                zoomValue.textContent = Math.round(zoomLevel * 100) + '%';
            }
        }

        // Add mouse wheel zoom support and enhanced event handling
        function addZoomListeners() {
            if (cy) {
                cy.on('zoom', function(event) {
                    const zoomLevel = cy.zoom();
                    updateZoomSlider(zoomLevel);
                    updateZoomValue(zoomLevel);
                });

                // Add wheel zoom to the container
                const cyContainer = document.getElementById('cy');
                cyContainer.addEventListener('wheel', function(e) {
                    e.preventDefault();

                    if (cy && conceptData) {
                        const currentZoom = cy.zoom();
                        const zoomFactor = e.deltaY > 0 ? 0.98 : 1.02; // 2% ë‹¨ìœ„ë¡œ ì¡°ì •
                        const newZoom = Math.max(0.25, Math.min(3, currentZoom * zoomFactor));

                        // Zoom towards mouse position
                        const renderedPosition = {
                            x: e.offsetX,
                            y: e.offsetY
                        };

                        cy.zoom({
                            level: newZoom,
                            renderedPosition: renderedPosition
                        });

                        updateZoomSlider(newZoom);
                        updateZoomValue(newZoom);
                    }
                }, { passive: false });

                // Enhanced slider event handling
                const zoomSlider = document.getElementById('zoomSlider');
                if (zoomSlider) {
                    // ìŠ¬ë¼ì´ë” ë“œë˜ê·¸ ì‹œì‘
                    zoomSlider.addEventListener('mousedown', function() {
                        document.body.style.userSelect = 'none'; // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
                    });

                    // ìŠ¬ë¼ì´ë” ë“œë˜ê·¸ ë
                    zoomSlider.addEventListener('mouseup', function() {
                        document.body.style.userSelect = '';
                    });

                    // í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì›
                    zoomSlider.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                    }, { passive: false });

                    zoomSlider.addEventListener('touchmove', function(e) {
                        e.preventDefault();
                        // í„°ì¹˜ ìœ„ì¹˜ ê³„ì‚°í•˜ì—¬ ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
                        const touch = e.touches[0];
                        const rect = zoomSlider.getBoundingClientRect();
                        const percentage = Math.max(0, Math.min(1, (touch.clientX - rect.left) / rect.width));
                        const value = 0.25 + (percentage * (3 - 0.25));
                        handleZoomSlider(value);
                    }, { passive: false });

                    // í‚¤ë³´ë“œ ì§€ì› (ìŠ¬ë¼ì´ë” í¬ì»¤ìŠ¤ ì‹œ)
                    zoomSlider.addEventListener('keydown', function(e) {
                        const currentValue = parseFloat(this.value);
                        let newValue = currentValue;

                        switch(e.key) {
                            case 'ArrowUp':
                            case 'ArrowRight':
                                newValue = Math.min(3, currentValue + 0.02);
                                break;
                            case 'ArrowDown':
                            case 'ArrowLeft':
                                newValue = Math.max(0.25, currentValue - 0.02);
                                break;
                            case 'Home':
                                newValue = 0.25;
                                break;
                            case 'End':
                                newValue = 3;
                                break;
                            default:
                                return;
                        }

                        e.preventDefault();
                        this.value = newValue;
                        handleZoomSlider(newValue);
                    });
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            setTimeout(() => {
                initializeCytoscape();
                updateConceptInputs(); // Initialize with default 2 concepts
                addZoomListeners(); // Add zoom event listeners
            }, 500);
        });
    </script>
</body>
</html>
