<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICE - Interactive Concept Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f, #4d79ff);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .comparison-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .concept-input {
            position: relative;
        }

        .concept-input input {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            width: 150px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
            transition: all 0.3s ease;
        }

        .concept-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .concept-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .vs-text {
            font-size: 1.5rem;
            font-weight: bold;
            align-self: center;
            color: #ffd93d;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .visualization-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #cy {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            pointer-events: auto;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd93d;
            margin-bottom: 5px;
        }

        .export-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: white;
        }

        .export-btn.mermaid {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }

        .export-btn.png {
            background: linear-gradient(135deg, #4d79ff, #7ba7ff);
        }

        .export-btn.json {
            background: linear-gradient(135deg, #6bcf7f, #95d5a3);
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .toggle-btn:first-child {
            border-radius: 20px 0 0 20px;
        }

        .toggle-btn:last-child {
            border-radius: 0 20px 20px 0;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #ffd93d, #ffeb3b);
            color: #333;
            font-weight: bold;
        }

        .mode-description {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .controls-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #6bcf7f, #95d5a3);
            color: #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-config input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .api-config input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .concept-count-selector select {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #333 !important;
            border: 2px solid rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        .concept-count-selector select:focus {
            outline: none;
            background: rgba(255, 255, 255, 1) !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .concept-count-selector select option {
            background: white !important;
            color: #333 !important;
            padding: 5px;
        }

        /* Zoom slider styles */
        .zoom-control {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 15px 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }

        .zoom-slider-container {
            position: relative;
            width: 30px;
            height: 150px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .zoom-slider {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            width: 8px;
            height: 150px;
            background: linear-gradient(to top, #ff6b6b 0%, #ffd93d 50%, #6bcf7f 100%);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            writing-mode: bt-lr;
            -webkit-writing-mode: vertical-lr;
            pointer-events: auto;
            z-index: 10000;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: 2px solid #ffd93d;
            transition: all 0.2s ease;
        }

        .zoom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
        }

        .zoom-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: 2px solid #ffd93d;
            transition: all 0.2s ease;
        }

        .zoom-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
        }

        .zoom-slider::-moz-range-track {
            background: transparent;
        }

        .zoom-label {
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .zoom-value {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 10px;
            min-width: 40px;
            text-align: center;
        }

        .zoom-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 10000;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Interactive Concept Explorer</h1>
            <p class="subtitle">AI-Powered Knowledge Network Visualization</p>
        </div>

        <div id="mode-description" class="mode-description">
            <strong>키워드 마인드맵:</strong> <span id="description-text">1-5개 개념을 AI가 분석하여 관계와 특성을 시각화합니다.</span>
        </div>

        <div class="comparison-controls">
            <div class="concept-count-selector" style="text-align: center; align-items: center;">
                <label style="margin-right: 10px; font-weight: bold;">분석할 개념 수:</label>
                <select id="conceptCount" onchange="updateConceptInputs()" style="padding: 8px; border-radius: 10px; margin-right: 10px;">
                    <option value="1">1개 (단독 분석)</option>
                    <option value="2" selected>2개 (비교 분석)</option>
                    <option value="3">3개 (다중 비교)</option>
                    <option value="4">4개 (다중 비교)</option>
                    <option value="5">5개 (다중 비교)</option>
                </select>
            </div>

            <div id="conceptInputs" class="concept-inputs-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center;">
                <!-- Dynamic inputs will be generated here -->
            </div>
        </div>

        <!-- Generate Button -->
        <div class="api-config" style="text-align: center; margin-bottom: 20px;">
            <button onclick="generateConceptsWithAI()" id="generateBtn" class="control-btn" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; padding: 12px 30px; font-size: 16px;">🤖 AI로 개념 분석하기</button>
        </div>

        <!-- Loading and Status -->
        <div id="loadingStatus" class="mode-description" style="display: none;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #ffd93d; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>AI가 개념을 생성하고 있습니다...</span>
            </div>
        </div>

        <div class="controls-panel">
            <button class="control-btn active" onclick="changeLayout('cose')" id="layout-cose">Force Layout</button>
            <button class="control-btn" onclick="changeLayout('circle')" id="layout-circle">Circle Layout</button>
            <button class="control-btn" onclick="changeLayout('concentric')" id="layout-concentric">Concentric Layout</button>
            <button class="control-btn" onclick="changeLayout('breadthfirst')" id="layout-breadth">Hierarchical</button>
        </div>

        <div class="visualization-area">
            <div id="cy" style="position: relative;">
                <!-- Zoom Control -->
                <div class="zoom-control" id="zoomControl" style="display: none;">
                    <div class="zoom-label">ZOOM</div>
                    <div class="zoom-buttons">
                        <button class="zoom-btn" onclick="zoomIn()" title="확대">+</button>
                        <button class="zoom-btn" onclick="zoomOut()" title="축소">-</button>
                    </div>
                    <div class="zoom-slider-container">
                        <input type="range"
                               class="zoom-slider"
                               id="zoomSlider"
                               min="0.25"
                               max="3"
                               step="0.02"
                               value="1"
                               orient="vertical"
                               oninput="handleZoomSlider(this.value)"
                               onchange="handleZoomSlider(this.value)"
                               title="확대/축소"
                               onmousedown="event.stopPropagation();"
                               onmousemove="event.stopPropagation();"
                               onmouseup="event.stopPropagation();">
                    </div>
                    <div class="zoom-value" id="zoomValue">100%</div>
                    <button class="zoom-btn" onclick="resetZoom()" title="초기화" style="margin-top: 10px; font-size: 12px;">🏠</button>
                </div>

                <div id="emptyState" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: rgba(255,255,255,0.7);">
                    <div style="font-size: 48px; margin-bottom: 20px;">🤖</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">우선 개념 분석을 해주세요</div>
                    <div style="font-size: 14px;">위에서 개념들을 입력하고 'AI로 개념 분석하기' 버튼을 클릭하세요</div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);"></div>
                    <span>주요 개념들</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #6bcf7f, #95d5a3);"></div>
                    <span>공통 개념</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ffd93d, #ffeb3b);"></div>
                    <span>고유 개념</span>
                </div>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="shared-count">-</div>
                <div>공통 개념</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-unique-count">-</div>
                <div>총 고유 개념</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="concept-count">-</div>
                <div>분석 개념 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-similarity">-</div>
                <div>평균 관련성</div>
            </div>
        </div>

        <div class="export-panel">
            <h3 style="text-align: center; margin-bottom: 15px;">📤 Export Options</h3>
            <div class="export-buttons">
                <button class="export-btn mermaid" onclick="exportMermaid()">Mermaid 다이어그램</button>
                <button class="export-btn png" onclick="exportPNG()">PNG 이미지</button>
                <button class="export-btn json" onclick="exportJSON()">JSON 데이터</button>
            </div>
        </div>
    </div>

    <script>
        let cy;
        let currentLayout = 'cose';
        let isGenerating = false;

        // Backend API Configuration
        const BACKEND_API_URL = 'http://localhost:8000';

        // Data will be populated after AI analysis
        let conceptData = null;

        function initializeCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                wheelSensitivity: 0,
                
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'color': 'white',
                            'text-outline-width': 2,
                            'text-outline-color': 'rgba(0,0,0,0.5)',
                            'width': '80px',
                            'height': '80px',
                            'border-width': 3,
                            'border-opacity': 0.8,
                            'transition-property': 'all',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'node[type="main1"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#ff6b6b #ff8e8e',
                            'border-color': '#ff4757',
                            'width': '100px',
                            'height': '100px',
                            'font-size': '14px'
                        }
                    },
                    {
                        selector: 'node[type="main2"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#4d79ff #7ba7ff',
                            'border-color': '#3742fa',
                            'width': '100px',
                            'height': '100px',
                            'font-size': '14px'
                        }
                    },
                    {
                        selector: 'node[type="shared"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#6bcf7f #95d5a3',
                            'border-color': '#2ed573',
                            'width': '85px',
                            'height': '85px'
                        }
                    },
                    {
                        selector: 'node[type="unique1"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#ffd93d #ffeb3b',
                            'border-color': '#ffa502',
                            'color': '#333',
                            'text-outline-color': 'rgba(255,255,255,0.8)',
                            'width': '70px',
                            'height': '70px'
                        }
                    },
                    {
                        selector: 'node[type="unique2"]',
                        style: {
                            'background-gradient-direction': 'to-bottom-right',
                            'background-gradient-stop-colors': '#a8edea #fed6e3',
                            'border-color': '#ff9ff3',
                            'color': '#333',
                            'text-outline-color': 'rgba(255,255,255,0.8)',
                            'width': '70px',
                            'height': '70px'
                        }
                    },
                    {
                        selector: 'node:hover',
                        style: {
                            'overlay-color': 'rgba(255,255,255,0.2)',
                            'overlay-padding': '10px',
                            'z-index': 10
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': 'rgba(255,255,255,0.4)',
                            'target-arrow-color': 'rgba(255,255,255,0.4)',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'opacity': 0.7,
                            'animation-name': 'flow',
                            'animation-duration': '2s',
                            'animation-iteration-count': 'infinite'
                        }
                    },
                    {
                        selector: 'edge[type="strong"]',
                        style: {
                            'width': 5,
                            'line-color': '#ffd93d',
                            'target-arrow-color': '#ffd93d',
                            'opacity': 0.9
                        }
                    },
                    {
                        selector: 'edge[type="shared"]',
                        style: {
                            'width': 4,
                            'line-color': '#6bcf7f',
                            'target-arrow-color': '#6bcf7f',
                            'opacity': 0.8
                        }
                    }
                ],

                elements: [],

                layout: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    randomize: false,
                    componentSpacing: 100,
                    nodeOverlap: 20,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 2000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0
                }
            });

            // 노드 클릭 이벤트
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const concept = node.data('label');
                showConceptTooltip(concept, evt.renderedPosition);
                
                // 연결된 노드들 강조
                const connectedNodes = node.connectedEdges().connectedNodes();
                cy.elements().removeClass('highlighted');
                node.addClass('highlighted');
                connectedNodes.addClass('highlighted');
            });

            generateGraph();
        }

        // Dynamic input field management
        function updateConceptInputs() {
            const count = parseInt(document.getElementById('conceptCount').value);
            const container = document.getElementById('conceptInputs');

            // Update description based on concept count
            const descriptionText = document.getElementById('description-text');
            if (count === 1) {
                descriptionText.textContent = '1개 개념을 AI가 깊이 분석하여 핵심 특성들을 시각화합니다.';
            } else {
                descriptionText.textContent = `${count}개 개념을 AI가 분석하여 공통점과 차이점을 시각화합니다.`;
            }

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                // Add VS text between inputs (not before first, and only if more than 1 concept)
                if (i > 0 && count > 1) {
                    const vsDiv = document.createElement('div');
                    vsDiv.className = 'vs-text';
                    vsDiv.textContent = 'VS';
                    vsDiv.style.fontSize = '1.2rem';
                    vsDiv.style.fontWeight = 'bold';
                    vsDiv.style.color = '#ffd93d';
                    vsDiv.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';
                    container.appendChild(vsDiv);
                }

                const inputDiv = document.createElement('div');
                inputDiv.className = 'concept-input';

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `concept${i + 1}`;
                input.placeholder = count === 1 ? '분석할 개념' : `개념 ${i + 1}`;
                input.addEventListener('input', debounce(() => {
                    // Could add real-time validation here
                }, 500));

                inputDiv.appendChild(input);
                container.appendChild(inputDiv);
            }
        }

        function generateGraph() {
            if (!conceptData) {
                console.log('No concept data available');
                return;
            }

            // Hide empty state, show stats and zoom control
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'grid';
            document.getElementById('zoomControl').style.display = 'flex';

            const elements = [];
            const colors = [
                '#ff6b6b', '#4d79ff', '#a8edea', '#ffa8e4', '#ff9f43'  // Colors for different concepts
            ];

            // Main concept nodes
            conceptData.concepts.forEach((concept, index) => {
                elements.push({
                    data: {
                        id: `main_${index}`,
                        label: concept.name,
                        type: `main${index + 1}`,
                        color: colors[index % colors.length]
                    }
                });
            });

            // Shared concepts (only if more than 1 concept and has shared concepts)
            if (conceptData.concepts.length > 1 && conceptData.shared_concepts.length > 0) {
                conceptData.shared_concepts.forEach((sharedConcept, i) => {
                    const id = `shared_${i}`;
                    elements.push({
                        data: {
                            id,
                            label: sharedConcept,
                            type: 'shared'
                        }
                    });

                    // Connect to all main concepts
                    conceptData.concepts.forEach((_, conceptIndex) => {
                        elements.push({
                            data: {
                                id: `edge_main${conceptIndex}_${id}`,
                                source: `main_${conceptIndex}`,
                                target: id,
                                type: 'shared'
                            }
                        });
                    });
                });
            }

            // Unique concepts for each main concept
            conceptData.concepts.forEach((concept, conceptIndex) => {
                concept.unique.forEach((uniqueConcept, i) => {
                    const id = `unique_${conceptIndex}_${i}`;
                    elements.push({
                        data: {
                            id,
                            label: uniqueConcept,
                            type: `unique${conceptIndex + 1}`
                        }
                    });

                    // Connect to main concept
                    elements.push({
                        data: {
                            id: `edge_main${conceptIndex}_${id}`,
                            source: `main_${conceptIndex}`,
                            target: id,
                            type: 'normal'
                        }
                    });
                });
            });
            
            cy.elements().remove();
            cy.add(elements);
            
            // 레이아웃 적용
            const layout = cy.layout({
                name: currentLayout,
                animate: true,
                animationDuration: 1000,
                randomize: false,
                componentSpacing: 100,
                nodeOverlap: 20,
                nestingFactor: 5,
                gravity: 80,
                numIter: 2000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0,
                spacingFactor: 1.5
            });

            layout.run();

            // 레이아웃 완료 후 줌 상태 초기화
            layout.on('layoutstop', function() {
                setTimeout(() => {
                    const zoomLevel = cy.zoom();
                    updateZoomSlider(zoomLevel);
                    updateZoomValue(zoomLevel);
                }, 100);
            });

            // 통계 업데이트
            updateStats();
        }

        function changeLayout(layoutName) {
            currentLayout = layoutName;
            
            // 버튼 활성화 상태 업데이트
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`layout-${layoutName}`).classList.add('active');
            
            const layoutOptions = {
                cose: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    componentSpacing: 100,
                    nodeOverlap: 20,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 2000,
                    spacingFactor: 1.5
                },
                circle: {
                    name: 'circle',
                    animate: true,
                    animationDuration: 1000,
                    spacing: 100
                },
                concentric: {
                    name: 'concentric',
                    animate: true,
                    animationDuration: 1000,
                    spacingFactor: 2,
                    concentric: function(node) {
                        if (node.data('type').includes('main')) return 3;
                        if (node.data('type') === 'shared') return 2;
                        return 1;
                    },
                    levelWidth: function() { return 1; }
                },
                breadthfirst: {
                    name: 'breadthfirst',
                    animate: true,
                    animationDuration: 1000,
                    directed: true,
                    roots: ['main1', 'main2'],
                    spacingFactor: 1.5
                }
            };
            
            const layout = cy.layout(layoutOptions[layoutName]);
            layout.run();

            // 레이아웃 변경 완료 후 줌 상태 업데이트
            layout.on('layoutstop', function() {
                setTimeout(() => {
                    const zoomLevel = cy.zoom();
                    updateZoomSlider(zoomLevel);
                    updateZoomValue(zoomLevel);
                }, 100);
            });
        }


        function showConceptTooltip(concept, position) {
            // 실제 구현에서는 여기에 상세 정보 팝업 표시
            console.log(`Concept clicked: ${concept} at position:`, position);
        }

        function updateStats() {
            if (!conceptData) return;

            const isSingleConcept = conceptData.concepts.length === 1;

            if (isSingleConcept) {
                // Single concept stats
                document.getElementById('shared-count').textContent = '-';
                document.getElementById('total-unique-count').textContent = conceptData.concepts[0].unique.length;
                document.getElementById('concept-count').textContent = '1 (단독 분석)';
                document.getElementById('avg-similarity').textContent = '-';

                // Update stat labels for single concept
                document.querySelector('#statsPanel .stat-card:nth-child(1) div:last-child').textContent = '공통 개념 (해당 없음)';
                document.querySelector('#statsPanel .stat-card:nth-child(2) div:last-child').textContent = '핵심 특성';
                document.querySelector('#statsPanel .stat-card:nth-child(4) div:last-child').textContent = '관련성 (해당 없음)';
            } else {
                // Multi-concept stats
                document.getElementById('shared-count').textContent = conceptData.shared_concepts.length;
                const totalUniqueCount = conceptData.concepts.reduce((sum, concept) => sum + concept.unique.length, 0);
                document.getElementById('total-unique-count').textContent = totalUniqueCount;
                document.getElementById('concept-count').textContent = conceptData.concepts.length;

                // Calculate average similarity based on shared vs total concepts
                const totalConcepts = conceptData.shared_concepts.length + totalUniqueCount;
                const avgSimilarity = totalConcepts > 0 ? Math.round((conceptData.shared_concepts.length / totalConcepts) * 100) : 0;
                document.getElementById('avg-similarity').textContent = avgSimilarity + '%';

                // Reset stat labels for multi-concept
                document.querySelector('#statsPanel .stat-card:nth-child(1) div:last-child').textContent = '공통 개념';
                document.querySelector('#statsPanel .stat-card:nth-child(2) div:last-child').textContent = '총 고유 개념';
                document.querySelector('#statsPanel .stat-card:nth-child(4) div:last-child').textContent = '평균 관련성';
            }
        }

        function exportMermaid() {
            if (!conceptData) {
                alert('먼저 개념 분석을 수행해주세요.');
                return;
            }

            let code = "graph TD\n";

            // 스타일 정의
            code += "    classDef shared fill:#6bcf7f,stroke:#2ed573,stroke-width:2px,color:#fff\n";
            code += "    classDef unique fill:#ffd93d,stroke:#ffa502,stroke-width:2px,color:#333\n";

            // 메인 노드들과 스타일
            conceptData.concepts.forEach((concept, i) => {
                const mainId = String.fromCharCode(65 + i); // A, B, C, D, E
                code += `    classDef main${i + 1} fill:#${['ff6b6b', '4d79ff', 'a8edea', 'ffa8e4', 'ff9f43'][i]},stroke-width:3px,color:#fff\n`;
                code += `    ${mainId}[${concept.name}]:::main${i + 1}\n`;
            });

            code += "\n";

            // 공통 개념들
            conceptData.shared_concepts.forEach((concept, i) => {
                const id = `S${i}`;
                code += `    ${id}[${concept}]:::shared\n`;
                conceptData.concepts.forEach((_, conceptIndex) => {
                    const mainId = String.fromCharCode(65 + conceptIndex);
                    code += `    ${mainId} --> ${id}\n`;
                });
            });

            code += "\n";

            // 고유 개념들
            conceptData.concepts.forEach((concept, conceptIndex) => {
                const mainId = String.fromCharCode(65 + conceptIndex);
                concept.unique.slice(0, 6).forEach((uniqueConcept, i) => {
                    const id = `U${conceptIndex}${i}`;
                    code += `    ${id}[${uniqueConcept}]:::unique\n`;
                    code += `    ${mainId} --> ${id}\n`;
                });
            });

            navigator.clipboard.writeText(code).then(() => {
                alert('🎉 Mermaid 다이어그램 코드가 클립보드에 복사되었습니다!\n\nGitHub README에 바로 붙여넣기 하세요.\n\n' + code.substring(0, 200) + '...');
            });
        }

        function exportPNG() {
            const png64 = cy.png({
                output: 'base64uri',
                bg: 'transparent',
                full: true,
                scale: 2
            });
            
            // 다운로드 링크 생성
            const link = document.createElement('a');
            link.download = 'concept-comparison.png';
            link.href = png64;
            link.click();
        }

        function exportJSON() {
            if (!conceptData) {
                alert('먼저 개념 분석을 수행해주세요.');
                return;
            }

            const conceptCount = parseInt(document.getElementById('conceptCount').value);
            const concepts = [];
            for (let i = 1; i <= conceptCount; i++) {
                concepts.push(document.getElementById(`concept${i}`).value);
            }

            const jsonData = {
                analysis: {
                    input_concepts: concepts,
                    concept_count: conceptData.concepts.length,
                    concepts: conceptData.concepts,
                    shared_concepts: conceptData.shared_concepts,
                    total_unique_concepts: conceptData.concepts.reduce((sum, c) => sum + c.unique.length, 0),
                    avg_similarity: parseInt(document.getElementById('avg-similarity').textContent) / 100,
                    layout: currentLayout,
                    generated_at: new Date().toISOString(),
                    graph_data: cy ? cy.json() : null
                }
            };

            navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2)).then(() => {
                alert('📊 JSON 데이터가 클립보드에 복사되었습니다!');
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 백엔드 API를 사용하여 개념 데이터 생성
        async function generateConceptsWithAI() {
            const conceptCount = parseInt(document.getElementById('conceptCount').value);
            const concepts = [];

            // Collect all concept values
            for (let i = 1; i <= conceptCount; i++) {
                const concept = document.getElementById(`concept${i}`).value.trim();
                if (!concept) {
                    if (conceptCount === 1) {
                        alert('분석할 개념을 입력해주세요.');
                    } else {
                        alert(`개념 ${i}을(를) 입력해주세요.`);
                    }
                    return;
                }
                concepts.push(concept);
            }

            // Check for duplicates (only if more than 1 concept)
            if (conceptCount > 1) {
                const uniqueConcepts = [...new Set(concepts.map(c => c.toLowerCase()))];
                if (uniqueConcepts.length !== concepts.length) {
                    alert('모든 개념은 서로 달라야 합니다.');
                    return;
                }
            }

            if (isGenerating) {
                return;
            }

            isGenerating = true;
            showLoadingState(true);

            try {
                /* START: 백엔드 API 연결 코드 */
                const response = await fetch(`${BACKEND_API_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        concepts: concepts
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `서버 오류: ${response.status}`);
                }

                const data = await response.json();
                /* END: 백엔드 API 연결 코드 */

                /* START: 테스트 데이터 (백엔드 연결 전 UI 테스트용) */
                //const data = generateTestData(concepts);
                /* END: 테스트 데이터 */

                // 생성된 데이터로 conceptData 업데이트
                conceptData = {
                    concepts: data.concepts,
                    shared_concepts: data.shared_concepts,
                    analysis_type: data.analysis_type
                };

                // 그래프 다시 생성
                generateGraph();

                ///// 분석 완료 메시지 start /////
                // let message;
                // if (conceptCount === 1) {
                //     message = `✨ AI가 "${concepts[0]}"의 분석을 완료했습니다!\n`;
                //     message += `핵심 특성: ${data.concepts[0].unique.length}개`;
                // } else {
                //     message = `✨ AI가 ${conceptCount}개 개념의 비교 분석을 완료했습니다!\n`;
                //     message += `공통 개념: ${data.shared_concepts.length}개\n`;
                //     message += `총 고유 개념: ${data.concepts.reduce((sum, c) => sum + c.unique.length, 0)}개`;
                // }

                // if (data.analysis_id) {
                //     message += `\n\n🔍 분석 ID: ${data.analysis_id}`;
                //     console.log(`LangSmith Trace ID: ${data.analysis_id}`);
                // }

                // alert(message);
                ///// 분석 완료 메시지 end /////
            } catch (error) {
                console.error('AI 분석 중 오류:', error);

                if (error.message.includes('Failed to fetch')) {
                    alert('❌ 백엔드 서버에 연결할 수 없습니다.\n\n백엔드 서버가 실행 중인지 확인해주세요:\n1. cd backend\n2. python main.py');
                } else {
                    alert(`❌ 오류가 발생했습니다: ${error.message}`);
                }
            } finally {
                isGenerating = false;
                showLoadingState(false);
            }
        }

        // 테스트 데이터 생성 함수 (UI 개발 및 테스트용)
        function generateTestData(inputConcepts) {
            const conceptCount = inputConcepts.length;

            if (conceptCount === 1) {
                return {
                    concepts: [{
                        name: inputConcepts[0],
                        unique: ["특성1", "특성2", "특성3", "특성4", "특성5", "특성6"]
                    }],
                    shared_concepts: [],
                    analysis_type: "single"
                };
            }

            const testShared = ["공통점1", "공통점2", "공통점3"];
            const testConcepts = inputConcepts.map((concept, i) => ({
                name: concept,
                unique: [`${concept} 고유특성1`, `${concept} 고유특성2`, `${concept} 고유특성3`]
            }));

            return {
                concepts: testConcepts,
                shared_concepts: testShared,
                analysis_type: "comparison"
            };
        }


        function showLoadingState(show) {
            const loadingDiv = document.getElementById('loadingStatus');
            const generateBtn = document.getElementById('generateBtn');

            if (show) {
                loadingDiv.style.display = 'block';
                generateBtn.disabled = true;
                generateBtn.textContent = '생성 중...';
                generateBtn.style.opacity = '0.6';
            } else {
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'AI로 개념 생성';
                generateBtn.style.opacity = '1';
            }
        }

        // Zoom control functions
        function handleZoomSlider(value) {
            if (cy) {
                const zoomLevel = parseFloat(value);
                cy.zoom(zoomLevel);
                cy.center();
                updateZoomValue(zoomLevel);

                // 슬라이더 값이 변경될 때마다 저장 (사용자 경험 개선)
                localStorage.setItem('conceptZoomLevel', zoomLevel.toString());
            }
        }

        function zoomIn() {
            if (cy) {
                const currentZoom = cy.zoom();
                const newZoom = Math.min(currentZoom * 1.2, 3);
                cy.zoom(newZoom);
                cy.center();
                updateZoomSlider(newZoom);
                updateZoomValue(newZoom);
            }
        }

        function zoomOut() {
            if (cy) {
                const currentZoom = cy.zoom();
                const newZoom = Math.max(currentZoom / 1.2, 0.25);
                cy.zoom(newZoom);
                cy.center();
                updateZoomSlider(newZoom);
                updateZoomValue(newZoom);
            }
        }

        function resetZoom() {
            if (cy) {
                cy.fit();
                const zoomLevel = cy.zoom();
                updateZoomSlider(zoomLevel);
                updateZoomValue(zoomLevel);
            }
        }

        function updateZoomSlider(zoomLevel) {
            const slider = document.getElementById('zoomSlider');
            if (slider) {
                slider.value = zoomLevel;
            }
        }

        function updateZoomValue(zoomLevel) {
            const zoomValue = document.getElementById('zoomValue');
            if (zoomValue) {
                zoomValue.textContent = Math.round(zoomLevel * 100) + '%';
            }
        }

        // Add mouse wheel zoom support and enhanced event handling
        function addZoomListeners() {
            if (cy) {
                cy.on('zoom', function(event) {
                    const zoomLevel = cy.zoom();
                    updateZoomSlider(zoomLevel);
                    updateZoomValue(zoomLevel);
                });


                // Enhanced slider event handling
                const zoomSlider = document.getElementById('zoomSlider');
                if (zoomSlider) {
                    // 슬라이더 이벤트 전파 중단
                    zoomSlider.addEventListener('mousedown', function(e) {
                        e.stopPropagation();
                        document.body.style.userSelect = 'none';
                    });

                    zoomSlider.addEventListener('mousemove', function(e) {
                        e.stopPropagation();
                    });

                    zoomSlider.addEventListener('mouseup', function(e) {
                        e.stopPropagation();
                        document.body.style.userSelect = '';
                    });

                    zoomSlider.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });

                    // 터치 이벤트 지원
                    zoomSlider.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }, { passive: false });

                    zoomSlider.addEventListener('touchmove', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }, { passive: false });

                    zoomSlider.addEventListener('touchend', function(e) {
                        e.stopPropagation();
                    });

                }
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            setTimeout(() => {
                initializeCytoscape();
                updateConceptInputs(); // Initialize with default 2 concepts
                addZoomListeners(); // Add zoom event listeners
            }, 500);
        });
    </script>
</body>
</html>
